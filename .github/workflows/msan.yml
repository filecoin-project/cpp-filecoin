name: MSAN

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
      name: checkout repo
    - name: cache
      uses: actions/cache@v1.2.0
      env:
        cache-name: cache-filecoin-ffi-proofs
        version: v28
      with:
        path: /var/tmp/filecoin-proof-parameters
        key: build-${{ env.cache-name }}-${{ env.version }}
    - name: checkout submodules
      shell: bash
      run: |
        auth_header="$(git config --local --get http.https://github.com/.extraheader)"
        git submodule sync --recursive
        git -c "http.extraheader=$auth_header" -c protocol.version=2 submodule update --init --force --recursive --depth=1
    - name: install
      run: |
        sudo apt-get update
        sudo apt-get install -y ninja-build python-setuptools pkg-config ocl-icd-* opencl-headers libhwloc-dev
        sudo python3 -m pip install --upgrade pip
        sudo python3 -m pip install scikit-build cmake requests gitpython gcovr pyyaml
    - name: instrument libc++
      env:
        CC: "clang"
        CXX: "clang++"
      run: |
        git clone --depth=1 https://github.com/llvm/llvm-project
        cd llvm-project
        mkdir build; cd build
        cmake -GNinja ../llvm -DCMAKE_BUILD_TYPE=Release -DLLVM_ENABLE_PROJECTS="libcxx;libcxxabi" -DLLVM_USE_SANITIZER=MemoryWithOrigins
        cmake --build . -- cxx cxxabi
    - name: instrument google test
      env:
        CC: "clang"
        CXX: "clang++"
        CFLAGS: "-fsanitize=memory -stdlib=libc++ -L/llvm-project/build/lib -lc++abi -I/llvm-project/build/include -I/llvm-project/build/include/c++/v1"
        CXXFLAGS: "-fsanitize=memory -stdlib=libc++ -L/llvm-project/build/lib -lc++abi -I/llvm-project/build/include -I/llvm-project/build/include/c++/v1"
      run: |
        git clone --depth=1 https://github.com/google/googletest.git
        mkdir gtest-msan && cd gtest-msan
        cmake ../googletest -DCMAKE_BUILD_TYPE=Release
        make -j2
    - name: cmake
      env:
        CC: "clang"
        CXX: "clang++"
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # has to be included to access other secrets
        GITHUB_HUNTER_USERNAME: ${{ secrets.HUNTER_USERNAME }}
        GITHUB_HUNTER_TOKEN: ${{ secrets.HUNTER_TOKEN }}
      run: cmake . -GNinja -Bbuild -D MSAN=ON -D TESTING_PROOFS=ON
    - name: build
      run: cmake --build build -- -j2
    - name: run tests
      env:
        CTEST_OUTPUT_ON_FAILURE: 1
      run: cmake --build build --target test
