/**
 * Copyright Soramitsu Co., Ltd. All Rights Reserved.
 * SPDX-License-Identifier: Apache-2.0
 */

#include "primitives/block/block.hpp"

#include <gtest/gtest.h>
#include "common/hexutil.hpp"
#include "testutil/cbor.hpp"
#include "testutil/crypto/sample_signatures.hpp"

/**
 * @given block header and its serialized representation from go
 * @when encode @and decode the block
 * @then decoded version matches the original @and encoded matches the go ones
 */
TEST(BlockTest, BlockHeaderCbor) {
  const auto kSampleBlsSignatureBytes2 =
      "020101010101010101010101010101010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101"_blob96;

  fc::primitives::block::BlockHeader block{
      fc::primitives::address::Address::makeFromId(1),
      boost::none,
      {
          {fc::primitives::sector::PoStProof{
              fc::primitives::sector::RegisteredProof::StackedDRG2KiBSeal,
              "F00D"_unhex,
          }},
          kSampleBlsSignature,
          {},
      },
      {"010001020002"_cid},
      fc::primitives::BigInt(3),
      4,
      "010001020005"_cid,
      "010001020006"_cid,
      "010001020007"_cid,
      fc::crypto::signature::Signature{kSampleBlsSignature},
      8,
      boost::none,
      9,
  };
  expectEncodeAndReencode(
      block,
      "8D420001F68381820342F00D586001010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101010101010101010101010101"
      "01018081D82A470001000102000242000304D82A4700010001020005D82A470001000102"
      "0006D82A4700010001020007586102010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101010101010101010101010101"
      "01010108F609"_unhex);
  block.ticket = fc::primitives::ticket::Ticket{kSampleBlsSignatureBytes2};
  block.block_sig = fc::crypto::bls::Signature{kSampleBlsSignatureBytes2};
  expectEncodeAndReencode(
      block,
      "8D4200018158600201010101010101010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101010101010101018381820342"
      "F00D58600101010101010101010101010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101010101018081D82A47000100"
      "0102000242000304D82A4700010001020005D82A4700010001020006D82A470001000102"
      "000758610201010101010101010101010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101010101010108586102020101"
      "010101010101010101010101010101010101010101010101010101010101010101010101"
      "010101010101010101010101010101010101010101010101010101010101010101010101"
      "01010101010101010101010101010101010101010109"_unhex);
}
